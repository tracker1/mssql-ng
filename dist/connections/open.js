"use strict";

var Promise = require("i-promise");
var mssql = require("mssql");
var stringify = require("json-stable-stringify");
var clone = require("safe-clone-deep");
var shadowClose = require("./shadow-close");
var query = require("../query");
var assign = require("../util/assign");

var _require = require("../cache");

var connections = _require.connections;
var promises = _require.promises;

var debug = require("debug")("mssql-ng");

module.exports = getConnection;

//gets/uses a pooled connection against the options specified
function getConnection(options) {
  debug("getConnection", "start", options);

  var key = null;
  var promise = null;
  try {
    //clone options
    options = clone(options);

    //serialize the options as a key for pools
    key = stringify(options || {});

    //if there's already a promise for the given connection, return it
    if (promises[key]) return promises[key];

    //create a new promise for the given connection options
    promise = promises[key] = createConnectionPromise(key, options);

    debug("getConnection", "success");
    return promise;
  } catch (err) {
    debug("getConnection", "error", err);
    return Promise.reject(err);
  }
};

//creates a promise that will resolve/reject an mssql connection for the options
function createConnectionPromise(key, options) {

  debug("createConnectionPromise", "start");

  //create promise that resolves to a connection
  var promise = new Promise(function (resolve, reject) {
    //create a new mssql connection
    var connection = new mssql.Connection(options, function (err) {
      return handleConnectionCallback(err, resolve, reject, key, connection);
    });
    debug("createConnectionPromise", "success");
  });

  //add mssql types to promise - convenience access
  assign(promise, mssql.TYPES); //add mssql types to promise being returned
  promise.MAX = mssql.MAX;

  //back reference to cache
  promise._mssqlngKey = key;

  //extended methods
  promise.close = function () {
    return promise.then(function (conn) {
      return conn.close();
    })["catch"](function () {
      delete promises[key];delete connections[key];
    });
  };
  promise.query = function (templateParts) {
    for (var _len = arguments.length, params = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      params[_key - 1] = arguments[_key];
    }

    return promise.then(function (conn) {
      return query(conn, {}, templateParts, params);
    });
  };
  promise.queryStream = function (templateParts) {
    for (var _len = arguments.length, params = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      params[_key - 1] = arguments[_key];
    }

    return promise.then(function (conn) {
      return query(conn, { stream: true }, templateParts, params);
    });
  };
  promise.output = require("../parameters/output");
  promise.input = require("../parameters/input");

  debug("createConnectionPromise", "success");
  return promise;
}

//handle promise resolution for connection callback
function handleConnectionCallback(err, resolve, reject, key, connection) {
  debug("handleConnectionCallback", "start");

  //error, remove cached entry, reject the promise
  if (err) {
    debug("handleConnectionCallback", "error", err);
    delete promises[key];
    return reject(err);
  }

  //patch close method for caching
  shadowClose(connection);

  //create a reference to the original connection for cleanup
  connection._mssqlngKey = key;
  connection.input = require("../parameters/input");
  connection.output = require("../parameters/input");

  //add connection to the pool
  connections[connection._mssqlngKey] = connection;

  //resolve the promise
  debug("handleConnectionCallback", "success");
  return resolve(connection);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25uZWN0aW9ucy9vcGVuLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ25DLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM3QixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUNqRCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN2QyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM1QyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDaEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7O2VBQ1YsT0FBTyxDQUFDLFVBQVUsQ0FBQzs7SUFBM0MsV0FBVyxZQUFYLFdBQVc7SUFBQyxRQUFRLFlBQVIsUUFBUTs7QUFDekIsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDOztBQUV6QyxNQUFNLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQzs7O0FBSS9CLFNBQVMsYUFBYSxDQUFDLE9BQU8sRUFBRTtBQUM5QixPQUFLLENBQUMsZUFBZSxFQUFDLE9BQU8sRUFBQyxPQUFPLENBQUMsQ0FBQzs7QUFFdkMsTUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDO0FBQ2YsTUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQ25CLE1BQUk7O0FBRUYsV0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzs7O0FBR3pCLE9BQUcsR0FBRyxTQUFTLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDOzs7QUFHL0IsUUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7OztB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QVUsQ0FBQyxDQUFDOzs7QUFHeEIsWUFBVSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7QUFDN0IsWUFBVSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUNsRCxZQUFVLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDOzs7QUFHbkQsYUFBVyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsR0FBRyxVQUFVLENBQUM7OztBQUdqRCxPQUFLLENBQUMsMEJBQTBCLEVBQUMsU0FBUyxDQUFDLENBQUM7QUFDNUMsU0FBTyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7Q0FDNUIiLCJmaWxlIjoic3JjL2Nvbm5lY3Rpb25zL29wZW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2ktcHJvbWlzZScpO1xudmFyIG1zc3FsID0gcmVxdWlyZSgnbXNzcWwnKTtcbnZhciBzdHJpbmdpZnkgPSByZXF1aXJlKCdqc29uLXN0YWJsZS1zdHJpbmdpZnknKTtcbmxldCBjbG9uZSA9IHJlcXVpcmUoJ3NhZmUtY2xvbmUtZGVlcCcpO1xubGV0IHNoYWRvd0Nsb3NlID0gcmVxdWlyZSgnLi9zaGFkb3ctY2xvc2UnKTtcbmxldCBxdWVyeSA9IHJlcXVpcmUoJy4uL3F1ZXJ5Jyk7XG5sZXQgYXNzaWduID0gcmVxdWlyZSgnLi4vdXRpbC9hc3NpZ24nKTtcbmxldCB7Y29ubmVjdGlvbnMscHJvbWlzZXN9ID0gcmVxdWlyZSgnLi4vY2FjaGUnKTtcbmxldCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ21zc3FsLW5nJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZ2V0Q29ubmVjdGlvbjtcblxuXG4vL2dldHMvdXNlcyBhIHBvb2xlZCBjb25uZWN0aW9uIGFnYWluc3QgdGhlIG9wdGlvbnMgc3BlY2lmaWVkXG5mdW5jdGlvbiBnZXRDb25uZWN0aW9uKG9wdGlvbnMpIHtcbiAgZGVidWcoJ2dldENvbm5lY3Rpb24nLCdzdGFydCcsb3B0aW9ucyk7XG5cbiAgbGV0IGtleSA9IG51bGw7XG4gIGxldCBwcm9taXNlID0gbnVsbDtcbiAgdHJ5IHtcbiAgICAvL2Nsb25lIG9wdGlvbnNcbiAgICBvcHRpb25zID0gY2xvbmUob3B0aW9ucyk7XG5cbiAgICAvL3NlcmlhbGl6ZSB0aGUgb3B0aW9ucyBhcyBhIGtleSBmb3IgcG9vbHNcbiAgICBrZXkgPSBzdHJpbmdpZnkob3B0aW9ucyB8fCB7fSk7XG5cbiAgICAvL2lmIHRoZXJlJ3MgYWxyZWFkeSBhIHByb21pc2UgZm9yIHRoZSBnaXZlbiBjb25uZWN0aW9uLCByZXR1cm4gaXRcbiAgICBpZiAocHJvbWlzZXNba2V5XSkgcmV0dXJuIHByb21pc2VzW2tleV07XG5cbiAgICAvL2NyZWF0ZSBhIG5ldyBwcm9taXNlIGZvciB0aGUgZ2l2ZW4gY29ubmVjdGlvbiBvcHRpb25zXG4gICAgcHJvbWlzZSA9IHByb21pc2VzW2tleV0gPSBjcmVhdGVDb25uZWN0aW9uUHJvbWlzZShrZXksIG9wdGlvbnMpO1xuXG4gICAgZGVidWcoJ2dldENvbm5lY3Rpb24nLCdzdWNjZXNzJylcbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfSBjYXRjaChlcnIpIHtcbiAgICBkZWJ1ZygnZ2V0Q29ubmVjdGlvbicsJ2Vycm9yJyxlcnIpO1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICB9XG59O1xuXG5cbi8vY3JlYXRlcyBhIHByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUvcmVqZWN0IGFuIG1zc3FsIGNvbm5lY3Rpb24gZm9yIHRoZSBvcHRpb25zXG5mdW5jdGlvbiBjcmVhdGVDb25uZWN0aW9uUHJvbWlzZShrZXksIG9wdGlvbnMpIHtcbiAgXG4gIGRlYnVnKCdjcmVhdGVDb25uZWN0aW9uUHJvbWlzZScsJ3N0YXJ0Jyk7XG5cbiAgLy9jcmVhdGUgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGEgY29ubmVjdGlvblxuICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLHJlamVjdCk9PntcbiAgICAvL2NyZWF0ZSBhIG5ldyBtc3NxbCBjb25uZWN0aW9uXG4gICAgbGV0IGNvbm5lY3Rpb24gPSBuZXcgbXNzcWwuQ29ubmVjdGlvbihvcHRpb25zLChlcnIpPT5oYW5kbGVDb25uZWN0aW9uQ2FsbGJhY2soZXJyLCByZXNvbHZlLCByZWplY3QsIGtleSwgY29ubmVjdGlvbikpO1xuICAgIGRlYnVnKCdjcmVhdGVDb25uZWN0aW9uUHJvbWlzZScsJ3N1Y2Nlc3MnKTtcbiAgfSk7XG5cbiAgLy9hZGQgbXNzcWwgdHlwZXMgdG8gcHJvbWlzZSAtIGNvbnZlbmllbmNlIGFjY2Vzc1xuICBhc3NpZ24ocHJvbWlzZSwgbXNzcWwuVFlQRVMpOyAvL2FkZCBtc3NxbCB0eXBlcyB0byBwcm9taXNlIGJlaW5nIHJldHVybmVkXG4gIHByb21pc2UuTUFYID0gbXNzcWwuTUFYO1xuICBcbiAgLy9iYWNrIHJlZmVyZW5jZSB0byBjYWNoZVxuICBwcm9taXNlLl9tc3NxbG5nS2V5ID0ga2V5O1xuXG4gIC8vZXh0ZW5kZWQgbWV0aG9kc1xuICBwcm9taXNlLmNsb3NlID0gKCk9PnByb21pc2UudGhlbigoY29ubik9PmNvbm4uY2xvc2UoKSkuY2F0Y2goKCk9PnsgZGVsZXRlIHByb21pc2VzW2tleV07IGRlbGV0ZSBjb25uZWN0aW9uc1trZXldIH0pO1xuICBwcm9taXNlLnF1ZXJ5ID0gKHRlbXBsYXRlUGFydHMsIC4uLnBhcmFtcyk9PnByb21pc2UudGhlbigoY29ubik9PnF1ZXJ5KGNvbm4se30sdGVtcGxhdGVQYXJ0cyxwYXJhbXMpKTtcbiAgcHJvbWlzZS5xdWVyeVN0cmVhbSA9ICh0ZW1wbGF0ZVBhcnRzLCAuLi5wYXJhbXMpPT5wcm9taXNlLnRoZW4oKGNvbm4pPT5xdWVyeShjb25uLHtzdHJlYW06dHJ1ZX0sdGVtcGxhdGVQYXJ0cyxwYXJhbXMpKTtcbiAgcHJvbWlzZS5vdXRwdXQgPSByZXF1aXJlKCcuLi9wYXJhbWV0ZXJzL291dHB1dCcpO1xuICBwcm9taXNlLmlucHV0ID0gcmVxdWlyZSgnLi4vcGFyYW1ldGVycy9pbnB1dCcpO1xuXG4gIGRlYnVnKCdjcmVhdGVDb25uZWN0aW9uUHJvbWlzZScsJ3N1Y2Nlc3MnKTtcbiAgcmV0dXJuIHByb21pc2U7XG59XG5cblxuLy9oYW5kbGUgcHJvbWlzZSByZXNvbHV0aW9uIGZvciBjb25uZWN0aW9uIGNhbGxiYWNrXG5mdW5jdGlvbiBoYW5kbGVDb25uZWN0aW9uQ2FsbGJhY2soZXJyLCByZXNvbHZlLCByZWplY3QsIGtleSwgY29ubmVjdGlvbikge1xuICBkZWJ1ZygnaGFuZGxlQ29ubmVjdGlvbkNhbGxiYWNrJywnc3RhcnQnKTtcblxuICAvL2Vycm9yLCByZW1vdmUgY2FjaGVkIGVudHJ5LCByZWplY3QgdGhlIHByb21pc2VcbiAgaWYgKGVycikge1xuICAgIGRlYnVnKCdoYW5kbGVDb25uZWN0aW9uQ2FsbGJhY2snLCdlcnJvcicsZXJyKTtcbiAgICBkZWxldGUgcHJvbWlzZXNba2V5XTtcbiAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gIH1cblxuICAvL3BhdGNoIGNsb3NlIG1ldGhvZCBmb3IgY2FjaGluZ1xuICBzaGFkb3dDbG9zZShjb25uZWN0aW9uKTtcblxuICAvL2NyZWF0ZSBhIHJlZmVyZW5jZSB0byB0aGUgb3JpZ2luYWwgY29ubmVjdGlvbiBmb3IgY2xlYW51cFxuICBjb25uZWN0aW9uLl9tc3NxbG5nS2V5ID0ga2V5O1xuICBjb25uZWN0aW9uLmlucHV0ID0gcmVxdWlyZSgnLi4vcGFyYW1ldGVycy9pbnB1dCcpO1xuICBjb25uZWN0aW9uLm91dHB1dCA9IHJlcXVpcmUoJy4uL3BhcmFtZXRlcnMvaW5wdXQnKTtcblxuICAvL2FkZCBjb25uZWN0aW9uIHRvIHRoZSBwb29sXG4gIGNvbm5lY3Rpb25zW2Nvbm5lY3Rpb24uX21zc3FsbmdLZXldID0gY29ubmVjdGlvbjtcblxuICAvL3Jlc29sdmUgdGhlIHByb21pc2VcbiAgZGVidWcoJ2hhbmRsZUNvbm5lY3Rpb25DYWxsYmFjaycsJ3N1Y2Nlc3MnKTtcbiAgcmV0dXJuIHJlc29sdmUoY29ubmVjdGlvbik7XG59Il19